\usetikzlibrary{backgrounds}

\begin{tikzpicture}[>=Stealth, every node/.style={font=\small, text=axis_text}]
  \path[use as bounding box] (-0.5,-3.4) rectangle (8.5,2.4);

  % Styles
  \tikzset{
    vertex/.style={
      circle, draw=axis_line, semithick, fill=white,
      minimum size=18pt, inner sep=0pt
    },
    source/.style={vertex, draw=my_blue, fill=my_blue!12},
    sink/.style={vertex, draw=my_red,  fill=my_red!12},
    edge/.style={->, semithick, draw=axis_line},
    capacity/.style={
      midway,
      inner sep=2pt,            % more “air” around the text
      rounded corners=1pt,
      text=axis_text,
      fill=white,               % hide the line behind the label
      draw=none                 % no border; omit this to have a box border
    }
  }

  \def\ROWS{3}
  \def\COLS{3}
  \pgfkeys{/pgf/number format/.cd,fixed,fixed zerofill,precision=1}

  % Flattened matrix A in row-major order:
  % [ [4.2, 3.5, 2.6],
  %   [1.1, 2.1, 8.3],
  %   [6.5, 3.9, 1.2] ]
  \def\A{4.2,3.5,2.6,1.1,2.1,8.3,6.5,3.9,1.2}

  % Helper: A_{ij}
  \newcommand{\Aij}[2]{%
    \pgfmathtruncatemacro{\idx}{(#1-1)*\COLS + #2-1}%
    \pgfmathparse{{\A}[\idx]}%
    \pgfmathresult%
  }

  % Nodes
  \node[source] (s) at (0, 0) {$s$};
  \node[sink]   (t) at (8, 0) {$t$};

  % Row nodes
  \foreach \i in {1,...,\ROWS} {
    \node[vertex] (u\i) at (2, {(\ROWS - 1) - (\i - 1) * 2}) {$u_{\i}$};
  }

  % Column nodes
  \foreach \j in {1,...,\COLS} {
    \node[vertex] (v\j) at (6, {(\COLS - 1) - (\j - 1) * 2}) {$v_{\j}$};
  }

  % Edges from source to row nodes: row sums r_i = sum_j A_{ij}
  \foreach \i in {1,...,\ROWS} {
    \pgfmathsetmacro{\rowsum}{0}%
    \foreach \j in {1,...,\COLS} {
      \pgfmathtruncatemacro{\idx}{(\i-1)*\COLS + (\j-1)}%
      \pgfmathsetmacro{\rowsum}{\rowsum + {\A}[\idx]}%
      \xdef\rowsum{\rowsum}%
    }
    \draw[edge] (s) -- node[capacity, sloped] {\pgfmathprintnumber{\rowsum}} (u\i);
  }

  % Edges from column nodes to sink: column sums s_j = sum_i A_{ij}
  \foreach \j in {1,...,\COLS} {
    \pgfmathsetmacro{\colsum}{0}%
    \foreach \i in {1,...,\ROWS} {
      \pgfmathtruncatemacro{\idx}{(\i-1)*\COLS + (\j-1)}%
      \pgfmathsetmacro{\colsum}{\colsum + {\A}[\idx]}%
      \xdef\colsum{\colsum}%
    }
    \draw[edge] (v\j) -- node[capacity, sloped] {\pgfmathprintnumber{\colsum}} (t);
  }

  % Draw the edges in the center
  \foreach \i in {1,...,\ROWS} {
    \foreach \j in {1,...,\COLS} {
      \draw[edge] (u\i) -- (v\j);
    }
  }

  % Add the labels (avoid overlap)
  \foreach \i in {1,...,\ROWS} {
    \ifodd\i
    \def\labpos{0.3}
    \else
    \def\labpos{0.7}
    \fi
    \foreach \j in {1,...,\COLS} {
      \path (u\i) -- (v\j)
      node[capacity, pos=\labpos, sloped] {$\Aij{\i}{\j}$};
    }
  }

  % Final edge from sink to source, loop around in arc
  \draw[edge] (t) to[bend left=90, looseness=1.3] (s);
\end{tikzpicture}
